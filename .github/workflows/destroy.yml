name: Nuclear Cleanup - Destroy ALL AWS Resources

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      confirm_destroy:
        description: 'Type "NUCLEAR" to confirm complete destruction'
        required: true
        default: ''

jobs:
  nuclear-cleanup:
    name: Complete AWS Resource Destruction
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_destroy == 'NUCLEAR'
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
        
    - name: List all resources before destruction
      run: |
        echo "üîç SCANNING ALL AWS RESOURCES BEFORE DESTRUCTION..."
        echo "=================================================="
        
        echo "=== EC2 INSTANCES ==="
        aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId,State.Name,Tags[?Key==`Name`].Value|[0],InstanceType]' --output table || echo "No instances"
        
        echo "=== RDS INSTANCES ==="
        aws rds describe-db-instances --query 'DBInstances[*].[DBInstanceIdentifier,DBInstanceStatus,Engine]' --output table || echo "No RDS instances"
        
        echo "=== S3 BUCKETS ==="
        aws s3 ls || echo "No buckets"
        
        echo "=== ECR REPOSITORIES ==="
        aws ecr describe-repositories --query 'repositories[*].[repositoryName,repositoryUri]' --output table || echo "No ECR repos"
        
        echo "=== ECS CLUSTERS ==="
        aws ecs list-clusters --query 'clusterArns' --output table || echo "No ECS clusters"
        
        echo "=== LAMBDA FUNCTIONS ==="
        aws lambda list-functions --query 'Functions[*].[FunctionName,Runtime]' --output table || echo "No Lambda functions"
        
        echo "=== LOAD BALANCERS ==="
        aws elbv2 describe-load-balancers --query 'LoadBalancers[*].[LoadBalancerName,Type,State.Code]' --output table || echo "No ALBs"
        aws elb describe-load-balancers --query 'LoadBalancerDescriptions[*].[LoadBalancerName,Scheme]' --output table || echo "No Classic ELBs"
        
        echo "=== VPCs ==="
        aws ec2 describe-vpcs --query 'Vpcs[*].[VpcId,IsDefault,State,Tags[?Key==`Name`].Value|[0]]' --output table || echo "No VPCs"
        
        echo "=== NAT GATEWAYS ==="
        aws ec2 describe-nat-gateways --query 'NatGateways[*].[NatGatewayId,State,VpcId]' --output table || echo "No NAT Gateways"
        
        echo "=== INTERNET GATEWAYS ==="
        aws ec2 describe-internet-gateways --query 'InternetGateways[*].[InternetGatewayId,Attachments[0].VpcId,Attachments[0].State]' --output table || echo "No IGWs"
        
        echo "=== ELASTIC IPs ==="
        aws ec2 describe-addresses --query 'Addresses[*].[PublicIp,AllocationId,AssociationId]' --output table || echo "No Elastic IPs"
        
        echo "=== SECURITY GROUPS ==="
        aws ec2 describe-security-groups --query 'SecurityGroups[?GroupName!=`default`].[GroupId,GroupName,VpcId]' --output table || echo "No custom security groups"

    - name: 1. Cleanup Lambda Functions
      run: |
        echo "üßπ STEP 1: DESTROYING ALL LAMBDA FUNCTIONS..."
        aws lambda list-functions --query 'Functions[*].FunctionName' --output text | tr '\t' '\n' | while read FUNC; do
          if [ ! -z "$FUNC" ]; then
            echo "Deleting Lambda function: $FUNC"
            aws lambda delete-function --function-name "$FUNC" || echo "Failed to delete $FUNC"
          fi
        done

    - name: 2. Cleanup ECR Repositories
      run: |
        echo "üßπ STEP 2: DESTROYING ALL ECR REPOSITORIES..."
        aws ecr describe-repositories --query 'repositories[*].repositoryName' --output text | tr '\t' '\n' | while read REPO; do
          if [ ! -z "$REPO" ]; then
            echo "Deleting ECR repository: $REPO"
            aws ecr delete-repository --repository-name "$REPO" --force || echo "Failed to delete $REPO"
          fi
        done

    - name: 3. Cleanup ECS Resources
      run: |
        echo "üßπ STEP 3: DESTROYING ALL ECS RESOURCES..."
        
        # Get all clusters
        aws ecs list-clusters --query 'clusterArns' --output text | tr '\t' '\n' | while read CLUSTER_ARN; do
          if [ ! -z "$CLUSTER_ARN" ]; then
            CLUSTER_NAME=$(basename "$CLUSTER_ARN")
            echo "Processing ECS cluster: $CLUSTER_NAME"
            
            # Stop all services in cluster
            aws ecs list-services --cluster "$CLUSTER_NAME" --query 'serviceArns' --output text | tr '\t' '\n' | while read SERVICE_ARN; do
              if [ ! -z "$SERVICE_ARN" ]; then
                SERVICE_NAME=$(basename "$SERVICE_ARN")
                echo "Stopping service: $SERVICE_NAME"
                aws ecs update-service --cluster "$CLUSTER_NAME" --service "$SERVICE_NAME" --desired-count 0 || echo "Failed to stop $SERVICE_NAME"
                aws ecs delete-service --cluster "$CLUSTER_NAME" --service "$SERVICE_NAME" || echo "Failed to delete $SERVICE_NAME"
              fi
            done
            
            # Delete cluster
            echo "Deleting cluster: $CLUSTER_NAME"
            aws ecs delete-cluster --cluster "$CLUSTER_NAME" || echo "Failed to delete cluster"
          fi
        done

    - name: 4. Cleanup RDS Resources
      run: |
        echo "üßπ STEP 4: DESTROYING ALL RDS RESOURCES..."
        
        # Delete all DB instances
        aws rds describe-db-instances --query 'DBInstances[*].DBInstanceIdentifier' --output text | tr '\t' '\n' | while read DB; do
          if [ ! -z "$DB" ]; then
            echo "Deleting RDS instance: $DB"
            aws rds delete-db-instance --db-instance-identifier "$DB" --skip-final-snapshot || echo "Failed to delete $DB"
          fi
        done
        
        # Wait for DB instances to start deleting
        sleep 30
        
        # Delete parameter groups
        aws rds describe-db-parameter-groups --query 'DBParameterGroups[?!starts_with(DBParameterGroupName, `default.`)].DBParameterGroupName' --output text | tr '\t' '\n' | while read PG; do
          if [ ! -z "$PG" ]; then
            echo "Deleting parameter group: $PG"
            aws rds delete-db-parameter-group --db-parameter-group-name "$PG" || echo "Failed to delete $PG"
          fi
        done
        
        # Delete subnet groups
        aws rds describe-db-subnet-groups --query 'DBSubnetGroups[?!starts_with(DBSubnetGroupName, `default`)].DBSubnetGroupName' --output text | tr '\t' '\n' | while read SG; do
          if [ ! -z "$SG" ]; then
            echo "Deleting subnet group: $SG"
            aws rds delete-db-subnet-group --db-subnet-group-name "$SG" || echo "Failed to delete $SG"
          fi
        done

    - name: 5. Cleanup Load Balancers
      run: |
        echo "üßπ STEP 5: DESTROYING ALL LOAD BALANCERS..."
        
        # Application Load Balancers
        aws elbv2 describe-load-balancers --query 'LoadBalancers[*].LoadBalancerArn' --output text | tr '\t' '\n' | while read ALB_ARN; do
          if [ ! -z "$ALB_ARN" ]; then
            echo "Deleting ALB: $ALB_ARN"
            aws elbv2 delete-load-balancer --load-balancer-arn "$ALB_ARN" || echo "Failed to delete ALB"
          fi
        done
        
        # Classic Load Balancers
        aws elb describe-load-balancers --query 'LoadBalancerDescriptions[*].LoadBalancerName' --output text | tr '\t' '\n' | while read ELB_NAME; do
          if [ ! -z "$ELB_NAME" ]; then
            echo "Deleting Classic ELB: $ELB_NAME"
            aws elb delete-load-balancer --load-balancer-name "$ELB_NAME" || echo "Failed to delete ELB"
          fi
        done

    - name: 6. Cleanup S3 Buckets
      run: |
        echo "üßπ STEP 6: DESTROYING ALL S3 BUCKETS..."
        
        aws s3 ls | awk '{print $3}' | while read BUCKET; do
          if [ ! -z "$BUCKET" ]; then
            echo "Emptying and deleting bucket: $BUCKET"
            
            # Remove all versions and delete markers
            aws s3api list-object-versions --bucket "$BUCKET" --query 'Versions[].{Key:Key,VersionId:VersionId}' --output text | while read KEY VERSION; do
              if [ ! -z "$KEY" ] && [ ! -z "$VERSION" ]; then
                aws s3api delete-object --bucket "$BUCKET" --key "$KEY" --version-id "$VERSION" || echo "Failed to delete version"
              fi
            done
            
            aws s3api list-object-versions --bucket "$BUCKET" --query 'DeleteMarkers[].{Key:Key,VersionId:VersionId}' --output text | while read KEY VERSION; do
              if [ ! -z "$KEY" ] && [ ! -z "$VERSION" ]; then
                aws s3api delete-object --bucket "$BUCKET" --key "$KEY" --version-id "$VERSION" || echo "Failed to delete marker"
              fi
            done
            
            # Empty bucket and delete
            aws s3 rm "s3://$BUCKET" --recursive || echo "Failed to empty $BUCKET"
            aws s3 rb "s3://$BUCKET" || echo "Failed to delete $BUCKET"
          fi
        done

    - name: 7. Terminate ALL EC2 Instances
      run: |
        echo "üßπ STEP 7: TERMINATING ALL EC2 INSTANCES..."
        
        aws ec2 describe-instances --filters "Name=instance-state-name,Values=running,stopped,stopping" --query 'Reservations[*].Instances[*].InstanceId' --output text | tr '\t' '\n' | while read INSTANCE_ID; do
          if [ ! -z "$INSTANCE_ID" ]; then
            echo "Terminating instance: $INSTANCE_ID"
            aws ec2 terminate-instances --instance-ids "$INSTANCE_ID" || echo "Failed to terminate $INSTANCE_ID"
          fi
        done

    - name: 8. Wait for instances to terminate
      run: |
